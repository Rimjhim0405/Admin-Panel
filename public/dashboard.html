<!DOCTYPE html>
<html>
    <head>
        <title>Dashboard - User Management</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
            }

            .sidebar {
                width: 280px;
                background: rgba(0, 0, 0, 0.9);
                backdrop-filter: blur(20px);
                border-right: 1px solid rgba(255, 255, 255, 0.1);
                height: 100vh;
                position: fixed;
                z-index: 100;
                overflow-y: auto;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .sidebar-header {
                padding: 30px 25px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                text-align: center;
            }

            .sidebar-header h1 {
                color: #fff;
                font-size: 24px;
                font-weight: 700;
                margin-bottom: 5px;
                background: linear-gradient(45deg, #00d4ff, #090979);
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            .sidebar-header p {
                color: rgba(255, 255, 255, 0.7);
                font-size: 14px;
            }

            .nav-menu {
                padding: 20px 0;
            }

            .nav-item {
                display: block;
                color: rgba(255, 255, 255, 0.8);
                padding: 18px 30px;
                text-decoration: none;
                transition: all 0.3s ease;
                border-left: 3px solid transparent;
                position: relative;
                overflow: hidden;
            }

            .nav-item:before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
                transition: left 0.5s;
            }

            .nav-item:hover:before {
                left: 100%;
            }

            .nav-item:hover {
                color: #fff;
                background: rgba(255, 255, 255, 0.1);
                border-left-color: #00d4ff;
                transform: translateX(5px);
            }

            .nav-item i {
                margin-right: 15px;
                width: 20px;
                text-align: center;
                font-size: 18px;
            }

            .main-content {
                margin-left: 280px;
                padding: 30px;
                width: calc(100% - 280px);
                min-height: 100vh;
            }

            .content-header {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                border-radius: 20px;
                padding: 30px;
                margin-bottom: 30px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            .content-header h1 {
                font-size: 60px;
                font-weight: 700;
                background: linear-gradient(135deg, #667eea, #764ba2);
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 10px;
            }

            .content-header p {
                color: rgba(0, 0, 0, 0.6);
                font-size: 16px;
            }

            .add-btn {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 15px 25px;
                border-radius: 50px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
                position: relative;
                overflow: hidden;
            }

            .add-btn:hover {
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
            }

            .add-btn i {
                margin-right: 8px;
            }

            .data-table-container {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                border-radius: 20px;
                overflow: hidden;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                animation: slideInUp 0.6s ease-out;
            }

            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .data-table {
                width: 100%;
                border-collapse: collapse;
            }

            .data-table thead {
                background: linear-gradient(135deg, #667eea, #764ba2);
            }

            .data-table th {
                color: white;
                padding: 20px;
                text-align: left;
                font-weight: 600;
                font-size: 14px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .data-table td {
                padding: 20px;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                font-size: 15px;
                color: #333;
                transition: all 0.3s ease;
            }

            .data-table tbody tr {
                transition: all 0.3s ease;
            }

            .data-table tbody tr:hover {
                background: rgba(102, 126, 234, 0.05);
                transform: scale(1.01);
            }

            .action-btn {
                padding: 8px 16px;
                border: none;
                border-radius: 25px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                margin-right: 8px;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
            }

            .edit-btn {
                background: linear-gradient(135deg, #4facfe, #00f2fe);
                color: white;
                box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
            }

            .edit-btn:hover {
                transform: translateY(-2px) scale(1.1);
                box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
            }

            .delete-btn {
                background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                color: white;
                box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
            }

            .delete-btn:hover {
                transform: translateY(-2px) scale(1.1);
                box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            }

            .popup-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(10px);
                z-index: 998;
                animation: fadeIn 0.3s ease-out;
            }

            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            .popup-form {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0.9);
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                padding: 40px;
                border-radius: 25px;
                box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
                z-index: 999;
                min-width: 400px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            }

            @keyframes popIn {
                to {
                    transform: translate(-50%, -50%) scale(1);
                }
            }

            .popup-form h3 {
                font-size: 28px;
                font-weight: 700;
                margin-bottom: 25px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                text-align: center;
            }

            .form-group {
                margin-bottom: 20px;
                position: relative;
            }

            .form-input {
                width: 100%;
                padding: 15px 20px;
                border: 2px solid rgba(102, 126, 234, 0.1);
                border-radius: 15px;
                font-size: 16px;
                background: rgba(255, 255, 255, 0.8);
                transition: all 0.3s ease;
                outline: none;
            }

            .form-input:focus {
                border-color: #667eea;
                background: rgba(255, 255, 255, 1);
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                transform: translateY(-2px);
            }

            .form-input::placeholder {
                color: rgba(0, 0, 0, 0.4);
                font-weight: 500;
            }

            .form-actions {
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-top: 30px;
            }

            .submit-btn {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
                min-width: 120px;
            }

            .submit-btn:hover {
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
            }

            .cancel-btn {
                background: rgba(255, 255, 255, 0.9);
                color: #666;
                border: 2px solid rgba(102, 126, 234, 0.2);
                padding: 15px 30px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 120px;
            }

            .cancel-btn:hover {
                background: rgba(102, 126, 234, 0.1);
                border-color: #667eea;
                transform: translateY(-2px);
            }

            .content-section {
                animation: slideInUp 0.6s ease-out;
            }

            .stats-card {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border-radius: 15px;
                padding: 20px;
                margin-bottom: 20px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                text-align: center;
            }

            .stats-card h4 {
                font-size: 32px;
                margin-bottom: 5px;
            }

            .stats-card p {
                opacity: 0.8;
                font-size: 14px;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: rgba(0, 0, 0, 0.5);
            }

            .empty-state i {
                font-size: 64px;
                margin-bottom: 20px;
                opacity: 0.3;
            }

            .empty-state h3 {
                font-size: 24px;
                margin-bottom: 10px;
            }

            .empty-state p {
                font-size: 16px;
            }

            @media (max-width: 768px) {
                .sidebar {
                    width: 100%;
                    height: auto;
                    position: relative;
                }
                
                .main-content {
                    margin-left: 0;
                    width: 100%;
                    padding: 20px;
                }
                
                .popup-form {
                    min-width: 90%;
                    margin: 0 5%;
                    padding: 30px 20px;
                }
                
                .content-header {
                    padding: 20px;
                }
                
                .data-table th,
                .data-table td {
                    padding: 15px 10px;
                    font-size: 14px;
                }
            }

            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            @keyframes shake {
                0%, 100% { transform: translate(-50%, -50%) translateX(0); }
                25% { transform: translate(-50%, -50%) translateX(-5px); }
                75% { transform: translate(-50%, -50%) translateX(5px); }
            }
        </style>
    </head>
    <body>
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><img src = "App Icon.png" width = "50" height = "50"> <br>Dashboard</h1>
                <p>User Management System</p>
                
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item" onclick="showContent('salesman')" id="salesman-nav">
                    <i class="fas fa-user-tie"></i>
                    Sales Team
                </a>
                <a href="#" class="nav-item" onclick="showContent('picker')" id="picker-nav">
                    <i class="far fa-address-book"></i>
                    Pickers
                </a>
            </nav>
        </div>

        <div class="main-content">
            <div id="salesman" class="content-section">
                <div class="content-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                        <div>
                            <h1><img src ="splash logo.png" width = "200" height = "50">  Sales Team  </h1>
                            <p>Manage your sales representatives and their information</p>
                        </div>
                        <button class="add-btn" onclick="addEntry('salesman')">
                            <i class="fas fa-plus"></i>
                            Add New Member
                        </button>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-user"></i> Name</th>
                                <th><i class="fas fa-envelope"></i> Email</th>
                                <th><i class="fas fa-password"></i> Password</th>
                                <th><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                           
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="picker" class="content-section" style="display:none;">
                <div class="content-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                        <div>
                            <h1><img src ="splash logo.png" width = "200" height = "50"> Pickers</h1>
                            <p>Manage your pickers and their details</p>
                        </div>
                        <button class="add-btn" onclick="addEntry('picker')">
                            <i class="fas fa-plus"></i>
                            Add New Picker
                        </button>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-user"></i> Name</th>
                                <th><i class="fas fa-envelope"></i> Email</th>
                                <th><i class="fas fa-password"></i> Password</th>
                                <th><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pickerTableBody">
                           
                        </tbody>
                    </table>
                    
                </div>
            </div>
        </div>

        <div id="popupOverlay" class="popup-overlay" onclick="closeForm()"></div>

        <div id="popupForm" class="popup-form" style="display:none;">
            <h3 id="formTitle">Add User</h3>
            <div class="form-group">
                <input id="nameInput" type="text" placeholder="Full Name" class="form-input" />
            </div>
            <div class="form-group">
                <input id="emailInput" type="email" placeholder="Email Address" class="form-input" />
            </div>
            <div class="form-group">
                <input id="passwordInput" type="text" placeholder="Password" class="form-input" />
            </div>
            <div class="form-actions">
                <button id="submitBtn" class="submit-btn">
                    <i class="fas fa-check"></i>
                    Add
                </button>
                <button onclick="closeForm()" class="cancel-btn">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
            </div>
        </div>
        
        <script>

            let currentEditingRow = null;
            let currentType = null;

            // API Configurationconst 
            const API_BASE_URL = '/api';

            // In-memory data storage (will be populated from API)
            let Users = {
                salesman: [],
                picker: []
            };

            // Initialize application when DOM is loaded
            document.addEventListener("DOMContentLoaded", () => {
                initializeApp();
            });

            // API Functions
            async function loadUsersFromAPI() {
                try {
                    const response = await fetch(`${API_BASE_URL}/users`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    Users.salesman = data.salesman || [];
                    Users.picker = data.picker || [];
                } catch (error) {
                    console.error('Error loading users from API:', error);
                    showNotification('Error connecting to server. Please try again.', 'error');
                    throw error;
                }
            }

            async function addUserToAPI(userData) {
                try {
                    const response = await fetch(`${API_BASE_URL}/users`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(userData)
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to add user');
                    }
                    
                    return data.user;
                } catch (error) {
                    console.error('Error adding user:', error);
                    throw error;
                }
            }

            async function updateUserInAPI(id, userData) {
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(userData)
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to update user');
                    }
                    
                    return data.user;
                } catch (error) {
                    console.error('Error updating user:', error);
                    throw error;
                }
            }

            async function deleteUserFromAPI(id) {
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to delete user');
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Error deleting user:', error);
                    throw error;
                }
            }

            function setupNavigation() {
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    const newItem = item.cloneNode(true);
                    item.parentNode.replaceChild(newItem, item);
                    
                    newItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        const itemId = newItem.id;
                        if (itemId === 'salesman-nav') {
                            showContent('salesman');
                            setActiveNavItem('salesman-nav');
                        } else if (itemId === 'picker-nav') {
                            showContent('picker');
                            setActiveNavItem('picker-nav');
                        }
                    });
                });
            }

            function setActiveNavItem(activeId) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    item.style.backgroundColor = '';
                    item.style.borderLeftColor = '';
                });
                
                const activeItem = document.getElementById(activeId);
                if (activeItem) {
                    activeItem.classList.add('active');
                    activeItem.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                    activeItem.style.borderLeftColor = '#00d4ff';
                }
            }

            function showContent(sectionId) {
                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                    section.classList.remove('active');
                });
                
                const activeSection = document.getElementById(sectionId);
                if (activeSection) {
                    activeSection.style.display = 'block';
                    activeSection.classList.add('active');
                    
                    setTimeout(() => {
                        activeSection.style.opacity = '1';
                        activeSection.style.transform = 'translateY(0)';
                    }, 10);
                }
            }

            function setupKeyboardShortcuts() {
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && currentType) {
                        const popupForm = document.getElementById('popupForm');
                        if (popupForm && popupForm.style.display !== 'none') {
                            event.preventDefault();
                            submitEntry(currentType);
                        }
                    }
                    
                    if (event.key === 'Escape') {
                        closeForm();
                    }
                    
                    if (event.ctrlKey && event.key.toLowerCase() === 'n') {
                        event.preventDefault();
                        const activeSection = document.querySelector('.content-section[style*="block"]');
                        if (activeSection) {
                            const sectionId = activeSection.id;
                            addEntry(sectionId);
                        }
                    }
                });
            }

            function setupFormValidation() {
                const inputs = ['nameInput', 'emailInput', 'passwordInput'];
                inputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', validateInput);
                        input.addEventListener('blur', validateInput);
                    }
                });
            }

            function validateInput(event) {
                const input = event.target;
                const value = input.value.trim();
                
                input.style.borderColor = '';
                input.style.boxShadow = '';
                
                if (input.id === 'emailInput' && value) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        input.style.borderColor = '#ff6b6b';
                        input.style.boxShadow = '0 0 0 3px rgba(255, 107, 107, 0.1)';
                    } else {
                        input.style.borderColor = '#4facfe';
                        input.style.boxShadow = '0 0 0 3px rgba(79, 172, 254, 0.1)';
                    }
                }
                
                if (input.id === 'passwordInput' && value) {
                    if (value.length < 6) {
                        input.style.borderColor = '#ff6b6b';
                        input.style.boxShadow = '0 0 0 3px rgba(255, 107, 107, 0.1)';
                    } else {
                        input.style.borderColor = '#4facfe';
                        input.style.boxShadow = '0 0 0 3px rgba(79, 172, 254, 0.1)';
                    }
                }
            }

            function clearInputs() {
                const inputs = ['nameInput', 'emailInput', 'passwordInput'];
                inputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = "";
                        input.style.borderColor = '';
                        input.style.boxShadow = '';
                    }
                });
            }

            function closeForm() {
                const popupForm = document.getElementById("popupForm");
                const popupOverlay = document.getElementById("popupOverlay");
                
                if (popupForm) {
                    popupForm.style.animation = 'popOut 0.3s ease-in forwards';
                    setTimeout(() => {
                        popupForm.style.display = "none";
                        popupForm.style.animation = '';
                    }, 300);
                }
                
                if (popupOverlay) {
                    popupOverlay.style.animation = 'fadeOut 0.3s ease-out forwards';
                    setTimeout(() => {
                        popupOverlay.style.display = "none";
                        popupOverlay.style.animation = '';
                    }, 300);
                }
                
                clearInputs();
                currentEditingRow = null;
                currentType = null;
            }

            function addEntry(type) {
                currentEditingRow = null;
                currentType = type;
                
                const formTitle = document.getElementById("formTitle");
                const submitBtn = document.getElementById("submitBtn");
                
                if (formTitle) {
                    formTitle.innerHTML = `<i class="fas fa-plus"></i> Add ${capitalize(type)}`;
                }
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Add';
                }
                
                showForm();
                clearInputs();
                
                setTimeout(() => {
                    const nameInput = document.getElementById("nameInput");
                    if (nameInput) nameInput.focus();
                }, 100);
            }

            function editEntry(row, type) {
                currentEditingRow = row;
                currentType = type;
                
                const formTitle = document.getElementById("formTitle");
                const submitBtn = document.getElementById("submitBtn");
                
                if (formTitle) {
                    formTitle.innerHTML = `<i class="fas fa-edit"></i> Edit ${capitalize(type)}`;
                }
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Update';
                }
                
                const nameInput = document.getElementById("nameInput");
                const emailInput = document.getElementById("emailInput");
                const passwordInput = document.getElementById("passwordInput");
                
                if (nameInput && row.cells[0]) nameInput.value = row.cells[0].textContent.trim();
                if (emailInput && row.cells[1]) emailInput.value = row.cells[1].textContent.trim();
                if (passwordInput) passwordInput.value = '';
                
                showForm();
                
                setTimeout(() => {
                    if (nameInput) nameInput.select();
                }, 100);
            }

            function showForm() {
                const popupOverlay = document.getElementById("popupOverlay");
                const popupForm = document.getElementById("popupForm");
                
                if (popupOverlay) {
                    popupOverlay.style.display = "block";
                    popupOverlay.style.animation = 'fadeIn 0.3s ease-out forwards';
                }
                if (popupForm) {
                    popupForm.style.display = "block";
                    popupForm.style.animation = 'popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
                }
            }

            async function submitEntry(type) {
                const nameInput = document.getElementById("nameInput");
                const emailInput = document.getElementById("emailInput");
                const passwordInput = document.getElementById("passwordInput");
                const submitBtn = document.getElementById("submitBtn");
                
                if (!nameInput || !emailInput || !passwordInput) {
                    showNotification("Form inputs not found.", 'error');
                    return;
                }
                
                const name = nameInput.value.trim();
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();

                const validation = validateFormData(name, email, password, currentEditingRow);
                if (!validation.isValid) {
                    showNotification(validation.message, 'error');
                    return;
                }

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<div class="loading"></div> Processing...';
                }

                try {
                    if (currentEditingRow && currentEditingRow.dataset.id) {

                        const id = currentEditingRow.dataset.id;
                        const updateData = { name, email, type };
                        
                        if (password && password !== '••••••••') {
                            updateData.password = password;
                        }
                        
                        const updatedUser = await updateUserInAPI(id, updateData);
                        
                        const userIndex = Users[type].findIndex(user => user._id === id);
                        if (userIndex !== -1) {
                            Users[type][userIndex] = updatedUser;
                        }
                        
                        showNotification(`${capitalize(type)} updated successfully!`, 'success');
                    } else {
                        const newUser = await addUserToAPI({ name, email, password, type });
                        
                        Users[type].push(newUser);
                        
                        showNotification(`${capitalize(type)} added successfully!`, 'success');
                    }

                    refreshTable(type);
                    closeForm();
                } catch (error) {
                    console.error('Error submitting entry:', error);
                    showNotification(error.message || 'An error occurred. Please try again.', 'error');
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = currentEditingRow ? 
                            '<i class="fas fa-save"></i> Update' : 
                            '<i class="fas fa-check"></i> Add';
                    }
                }
            }

            function validateFormData(name, email, password, isEdit = false) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (!name || !email) {
                    return { isValid: false, message: "Name and email are required." };
                }
                
                if (!password && !isEdit) {
                    return { isValid: false, message: "Password is required." };
                }
                
                if (name.length < 2) {
                    return { isValid: false, message: "Name must be at least 2 characters long." };
                }
                
                if (!emailRegex.test(email)) {
                    return { isValid: false, message: "Please enter a valid email address." };
                }
                
                if (password && password.length < 6) {
                    return { isValid: false, message: "Password must be at least 6 characters long." };
                }
                
                return { isValid: true };
            }

            function createRow(name, email, password, id, type) {
                const row = document.createElement("tr");
                row.dataset.id = id;
                row.style.opacity = '0';
                row.style.transform = 'translateY(20px)';

                [name, email, '••••••••'].forEach((text, index) => {
                    const td = document.createElement("td");
                    if (index === 2) { 
                        td.innerHTML = `
                            <span class="password-hidden">••••••••</span>
                            <span class="password-shown" style="display: none;">${password}</span>
                            <button class="toggle-password" onclick="togglePassword(this)" style="margin-left: 10px; background: none; border: none; color: #667eea; cursor: pointer;">
                                <i class="fas fa-eye"></i>
                            </button>
                        `;
                    } else {
                        td.textContent = text;
                    }
                    row.appendChild(td);
                });

                const actionTd = document.createElement("td");
                actionTd.innerHTML = `
                    <button class="action-btn edit-btn" onclick="editEntry(this.closest('tr'), '${type}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete-btn" onclick="confirmDelete('${id}', '${type}', '${name}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                row.appendChild(actionTd);

                setTimeout(() => {
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '1';
                    row.style.transform = 'translateY(0)';
                }, 100);

                return row;
            }

            function togglePassword(button) {
                const cell = button.closest('td');
                const hiddenSpan = cell.querySelector('.password-hidden');
                const shownSpan = cell.querySelector('.password-shown');
                const icon = button.querySelector('i');
                
                if (hiddenSpan.style.display === 'none') {
                    hiddenSpan.style.display = 'inline';
                    shownSpan.style.display = 'none';
                    icon.className = 'fas fa-eye';
                    button.title = 'Show password';
                } else {
                    hiddenSpan.style.display = 'none';
                    shownSpan.style.display = 'inline';
                    icon.className = 'fas fa-eye-slash';
                    button.title = 'Hide password';
                }
            }

            function loadSalesmanData() {
                const table = document.getElementById("userTableBody");
                if (!table) return;
                
                table.innerHTML = "";
                
                if (Users.salesman.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="4" class="empty-state">
                                <i class="fas fa-user-tie"></i>
                                <h3>No sales team members yet</h3>
                                <p>Click "Add New Member" to get started</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                Users.salesman.forEach((user, index) => {
                    setTimeout(() => {
                        const row = createRow(user.name, user.email, user.password, user._id, "salesman");
                        table.appendChild(row);
                    }, index * 100);
                });
            }

            function loadPickerData() {
                const table = document.getElementById("pickerTableBody");
                if (!table) return;
                
                table.innerHTML = "";
                
                if (Users.picker.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="4" class="empty-state">
                                <i class="fas fa-user-friends"></i>
                                <h3>No pickers yet</h3>
                                <p>Click "Add New Picker" to get started</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                Users.picker.forEach((user, index) => {
                    setTimeout(() => {
                        const row = createRow(user.name, user.email, user.password, user._id, "picker");
                        table.appendChild(row);
                    }, index * 100);
                });
            }

            function refreshTable(type) {
                if (type === 'salesman') {
                    loadSalesmanData();
                } else if (type === 'picker') {
                    loadPickerData();
                }
            }

            function capitalize(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            function showNotification(message, type = 'info') {
                const existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(notification => notification.remove());
                
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 25px;
                    border-radius: 10px;
                    color: white;
                    font-weight: 600;
                    z-index: 10000;
                    max-width: 350px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                    backdrop-filter: blur(10px);
                    animation: slideInRight 0.3s ease-out;
                    cursor: pointer;
                `;
                
                switch (type) {
                    case 'success':
                        notification.style.background = 'linear-gradient(135deg, #4facfe, #00f2fe)';
                        break;
                    case 'error':
                        notification.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a24)';
                        break;
                    case 'warning':
                        notification.style.background = 'linear-gradient(135deg, #feca57, #ff9ff3)';
                        break;
                    default:
                        notification.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                }
                
                let icon = '';
                switch (type) {
                    case 'success':
                        icon = '<i class="fas fa-check-circle" style="margin-right: 10px;"></i>';
                        break;
                    case 'error':
                        icon = '<i class="fas fa-exclamation-circle" style="margin-right: 10px;"></i>';
                        break;
                    case 'warning':
                        icon = '<i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i>';
                        break;
                    default:
                        icon = '<i class="fas fa-info-circle" style="margin-right: 10px;"></i>';
                }
                
                notification.innerHTML = icon + message;
                
                notification.addEventListener('click', () => {
                    notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                    setTimeout(() => notification.remove(), 300);
                });
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 5000);
            }

            const notificationStyles = document.createElement('style');
            notificationStyles.textContent = `
                @keyframes slideInRight {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes slideOutRight {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
                
                @keyframes popOut {
                    from {
                        transform: translate(-50%, -50%) scale(1);
                        opacity: 1;
                    }
                    to {
                        transform: translate(-50%, -50%) scale(0.9);
                        opacity: 0;
                    }
                }
                
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
            `;
            document.head.appendChild(notificationStyles);

            function handleAPIError(error) {
                console.error('API Error:', error);
                
                if (error.message.includes('Failed to fetch')) {
                    showNotification('Cannot connect to server. Please check if the backend is running.', 'error');
                } else if (error.message.includes('404')) {
                    showNotification('Resource not found.', 'error');
                } else if (error.message.includes('400')) {
                    showNotification('Invalid request. Please check your input.', 'error');
                } else if (error.message.includes('500')) {
                    showNotification('Server error. Please try again later.', 'error');
                } else {
                    showNotification(error.message || 'An unexpected error occurred.', 'error');
                }
            }

            async function apiCallWithRetry(apiCall, maxRetries = 3) {
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        return await apiCall();
                    } catch (error) {
                        if (attempt === maxRetries) {
                            throw error;
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    }
                }
            }

            async function initializeApp() {
                try {
                    showNotification('Loading dashboard...', 'info');
                    
                    await apiCallWithRetry(loadUsersFromAPI);
                    loadSalesmanData();
                    loadPickerData();
                    showContent('salesman');
                    setupNavigation();
                    setupKeyboardShortcuts();
                    setupFormValidation();
                    
                    setActiveNavItem('salesman-nav');
                    
                    showNotification('Dashboard loaded successfully!', 'success');
                } catch (error) {
                    console.error('Error initializing app:', error);
                    handleAPIError(error);
                    
                    showNotification('Running in offline mode. Some features may be limited.', 'warning');
                }
            }

            function checkConnection() {
                return fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    timeout: 5000
                }).then(response => response.ok).catch(() => false);
            }

            setInterval(async () => {
                const isConnected = await checkConnection();
                const connectionStatus = document.getElementById('connectionStatus');
                
                if (!connectionStatus) {
                    const status = document.createElement('div');
                    status.id = 'connectionStatus';
                    status.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        padding: 10px 15px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 600;
                        z-index: 1000;
                        transition: all 0.3s ease;
                    `;
                    document.body.appendChild(status);
                }
                
                const statusEl = document.getElementById('connectionStatus');
                if (isConnected) {
                    statusEl.innerHTML = '<i class="fas fa-wifi"></i> Connected';
                    statusEl.style.background = 'linear-gradient(135deg, #4facfe, #00f2fe)';
                    statusEl.style.color = 'white';
                } else {
                    statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
                    statusEl.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a24)';
                    statusEl.style.color = 'white';
                }
            }, 30000); // Check every 30 seconds


            async function confirmDelete(id, type, name) {
                const confirmation = confirm(`Are you sure you want to delete "${name}"?\n\nThis action cannot be undone.`);
                if (confirmation) {
                    try {
                        await apiCallWithRetry(() => deleteUserFromAPI(id));
                        
                        Users[type] = Users[type].filter(user => user._id !== id);
                        
                        refreshTable(type);
                        showNotification(`${name} has been deleted.`, 'success');
                    } catch (error) {
                        console.error('Error deleting user:', error);
                        handleAPIError(error);
                    }
                }
            }

        </script>
    </body>
</html>
